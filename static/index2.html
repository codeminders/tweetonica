<html>
<head>
    <link href="css/trontastic/jquery-ui-1.7.2.custom.css" rel="stylesheet" type="text/css" media="screen"/>
    <link href="css/style2.css" rel="stylesheet" type="text/css" media="screen"/>
    <script type="text/javascript" src="js/jquery-1.3.2.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.7.2.custom.min.js"></script>
    <script type="text/javascript" src="js/jquery.json-1.3.min.js"></script>
    <script type="text/javascript" src="js/api.js"></script>
    <script type="text/javascript">

        var cache = [];

        $(document).ready(function() {
            
            // aux functions 
            var escape_html = function(html) {
                return html.replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;').replace('"', '&quot;');
            };

            var render_group = function(g) {
                var container = $('<div>').addClass('clear');
                var node = $('<a>').attr({href: 'javascript:;', groupname:g.name}).addClass('groupclosed').click(function(e) {
                    open_group($(this));
                    e.stopPropagation();
                    e.preventDefault();
                });
                var span = $('<span>').append(g.name == '__ALL__' ? 'Uncategorized': g.name);
                $('#groups').append(container.append(node.append(span)));
            };

            var render_user = function(u) {
                var container   = $('<li class="userinfo green">');
                var picture     = $('<div>').addClass('userinfo_pic').append('<img src="' + u.profile_image_url + '" alt="' + escape_html(u.screen_name) + '" width="48" height="48"/>');
                var screen_name = $('<div>').addClass('userinfo_screenname').html('<a href="http://twitter.com/' + u.screen_name + '" target="_new">' + u.screen_name + '</a>');
                container.append(picture);
                container.append(screen_name);
                if (u.real_name && u.real_name != '')
                    container.append($('<div>').addClass('userinfo_realname').text(u.real_name));
                $('#groupmembers ul').append(container);
            }

            var open_page = function(id) {                
                $('.menu').removeClass('active');
                $('#m' + id).addClass('active');
                $('.page').hide();
                if (id != 'manage') {
                    $('#' + id).load(id + '.html').show();
                }
                else {
                    if (phalanges.api.token) {
                        $('#' + id).show();
                    } else {
                        $('#login-dialog').dialog('open');
                    }
                }
            };

            var open_group = function(e) {
                $('#groups a').removeClass('groupopen').addClass('groupclosed');
                e.removeClass('groupclosed').addClass('groupopen');

                var g = cache[e.attr('groupname')];
                $('#info_groupname').html(g.name == '__ALL__' ? 'Uncategorized': g.name);
                $('#info_groupfeed').attr('href', g.rssurl);

                $('#groupmembers ul').empty();
                for (var i = 0; i< g.users.length; i++) {
                    render_user(g.users[i]);    
                }
            }

            var do_login = function() {
                $('.error').hide();

                var screen_name = jQuery.trim($('#screen_name').val());
                var password    = jQuery.trim($('#password').val());

                if (screen_name == '')
                    $('#ename').show();

                if (password == '')
                    $('#epass').show();

                if (screen_name == '' || password == '')
                    return;

                phalanges.api.login(screen_name, password, function() {
                    $('#login-dialog').dialog('close');
                    $('#currentuser').html(screen_name);
                    $('#currentuserurl').attr('href', 'http://twitter.com/' + screen_name);
                    $('#loggedin').show();
                    $('#loggedout').hide();

                    phalanges.api.get_friends(function(results) {
                        for (var g in results) {
                            var group = results[g];
                            render_group(group);
                        }
                        cache = results;
                        open_group($('#groups a[groupname=__ALL__]'));
                        open_page('manage');
                    }, function(error) {
                        open_page('manage');
                    });
                },  function() {
                    $('#eauth').show();
                });
            };

            // UI initialization
            $('#login-dialog').dialog({
                buttons: {
                    'Cancel': function() {
                        $('#login-dialog').dialog('close');
                    },
                    'Login': function() {
                        do_login();                        
                    },
                },
                autoOpen: false,
                modal: true,
                resizable: false,
                title: 'Login to Phalanges',
                width: 350,
                open: function() {
                    setTimeout(function() {$('#screen_name').focus()}, 100);
                }
            });


            // handlers

            $('#groups a').click(function(e) {
                $(this).toggleClass('groupopen').toggleClass('groupclosed');
                e.stopPropagation();
                e.preventDefault();
            });

            $('.menu').click(function(e) {
                var pageid = this.id.substring(1);
                open_page(pageid);
                e.stopPropagation();
                e.preventDefault();
            });

            $('#logoutbutton').click(function(e) {
                $('#loggedin').hide();
                $('#loggedout').show();
                phalanges.api.token = null;
                cache = [];
                open_page('about');
                e.stopPropagation();
                e.preventDefault();
            });

            $('#loginbutton').click(function(e) {
                $('#login-dialog').dialog('open');
                e.stopPropagation();
                e.preventDefault();
            });

            $('#screen_name,#password').keypress(function(e) {
                if (e.which == 13) {
                    do_login();
                    e.preventDefault();
                    e.stopPropagation();
                }
            });

            $(':radio[name=viewstyle]').click(function() {
                if (this.value == 's')
                    $('.userinfo').addClass('short_details');
                else
                    $('.userinfo').removeClass('short_details');
            });

        });
    </script>
</head>
<body>
    <!-- header -->
    <div id="header">
        <div id="logo"></div>
        <div id="loginbox">
            <div id="loggedin" style="display:none">
                <a href="javascript:;" id="currentuserurl" target="_new"><span id="currentuser"></span></a> | <a href="javascript:;" id="logoutbutton">Log out</a>
            </div>
            <div id="loggedout">
                <a href="javascript:;" id="loginbutton">Log In</a>
            </div>
        </div>
        <div id="menubar">
            <div class="clear">
                <a href="javascript:;" class="menu" id="mabout"><span>about</span></a>
                <a href="javascript:;" class="menu" id="mmanage"><span>my groups</span></a>
                <a href="javascript:;" class="menu" id="mfaq"><span>faq</span></a>
                <a href="javascript:;" class="menu" id="mcontacts"><span>contacts</span></a>
            </div>
        </div>
    </div>
    <!-- content -->
    <div id="content">
        <div id="manage" class="page" style="display:none">
            <div id="groups">                
            </div>
            <div id="details">
                <div id="groupinfo">
                    <input type="radio" name="viewstyle" value="f" checked="checked"/> text ands icons
                    <input type="radio" name="viewstyle" value="s"/> icons only
                    <dl>
                        <dt>Name</dt>
                        <dd id="info_groupname"></dd>
                        <dt>RSS feed</dt>
                        <dd><a id="info_groupfeed" href="javascript:;"><img src="images/feed-icon-28x28.png" width="28" height="28" alt="RSS feed"/></a></dd>
                    </dl>
                </div>
                <div id="groupmembers">
                    <ul></ul>
                </div>
            </div>
        </div>
        <div id="faq" class="page" style="display:none"></div>
        <div id="about" class="page"></div>
        <div id="contact" class="page" style="display:none"></div>
    </div>
    <!-- footer -->
    <div id="footer">
        Copyrights blah-blah-blah
    </div>
    <!-- dialogs -->
    <div id="login-dialog" style="display:none">
        <table>
            <tr>
                <td>Twitter name: </td>
                <td>
                    <input id="screen_name"/>
                    <div class="error" id="ename" style="display:none">Please enter Twitter name</div>
                    <div class="error" id="eauth" style="display:none">Invalid credentials are entered</div>
                </td>
             </tr>
            <tr>
                <td>Password: </td>
                <td>
                    <input id="password" type="password"/>
                    <div class="error" id="epass" style="display:none">Please enter password</div>
                </td>
            </tr>
        </table>
    </div>

</body>
</html>